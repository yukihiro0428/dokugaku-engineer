<?php
//HTTPメソッドがPOSTだったら
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
	$review = [
		'title' => trim($_POST['title']),
		'author' => trim($_POST['author']),
		'status' => trim($_POST['status']),
		'time' => $_POST['time'],
		'evaluation' => (int)trim($_POST['evaluation']),
		'impressions' => trim($_POST['impressions'])
	];
}
?>
<?php require 'header.php'; ?>
<section class="global-links">
	<h3>登録完了ページ</h3>
	<?php
	include __DIR__ . '/link/link_list.php';
	include __DIR__ . '/link/link_registration.php';
	include __DIR__ . '/link/link_home.php';
	?>
</section>
<div class="actionPage">
	<!-- バリデート出力 -->
	<?php
	$validated = validate($review);
	if (count($validated)) :
	?>
		<ul>
			<?php foreach ($validated as $error) : ?>
				<li><?php echo $error; ?></li>
			<?php endforeach; ?>
		</ul>
	<?php endif; ?>

	<?php
	//SQLに登録する処理
	$sql = <<<EOT
INSERT INTO reviews (
	title,
	author,
	status,
	time,
	evaluation,
	impressions
) VALUES (
	"{$review['title']}",
	"{$review['author']}",
	"{$review['status']}",
	"{$review['time']}",
	"{$review['evaluation']}",
	"{$review['impressions']}"
)
EOT;

	$result = mysqli_query($link, $sql);
	if ($result) {
		echo '<p>データを追加しました</p>' . PHP_EOL;
	} else {
		echo '<p>Error:データの追加に失敗しました</p><p>再登録をお願い致します</p>' . PHP_EOL;
		error_log('Error: fail to add review');
		error_log('Debugging error:' . mysqli_error($link));
	}
	//連番を更新
	updateId($link);


	?>
</div>
<?php require 'footer.php'; ?>
